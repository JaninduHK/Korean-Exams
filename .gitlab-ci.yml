stages:
  - deploy

deploy_production:
  stage: deploy
  image: alpine:latest

  before_script:
    # Install required packages
    - apk add --no-cache openssh-client bash

    # Setup SSH
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    - |
      ssh $VPS_USERNAME@$VPS_HOST << 'ENDSSH'
        set -e

        echo "ğŸš€ Starting deployment..."

        # Load Node.js environment
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

        # If nvm not found, try loading from common locations
        if ! command -v node &> /dev/null; then
          [ -s "/root/.nvm/nvm.sh" ] && \. "/root/.nvm/nvm.sh"
        fi

        # Add common node paths
        export PATH="/usr/local/bin:/usr/bin:$PATH"

        # Verify Node.js is available
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

        # Navigate to project directory
        cd /var/www/koreanexams

        # Pull latest code
        echo "ğŸ“¦ Pulling latest code..."
        git pull gitlab main

        # Install server dependencies
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm install --production

        # Install and build client
        echo "ğŸ“¦ Installing client dependencies..."
        cd ../client
        npm install

        echo "ğŸ—ï¸  Building client..."
        npm run build

        # Restart PM2
        echo "ğŸ”„ Restarting application..."
        cd ..
        pm2 reload ecosystem.config.js --env production
        pm2 save

        echo "âœ… Deployment completed successfully!"
        pm2 status
      ENDSSH

  only:
    - main

  when: manual

  environment:
    name: production
    url: https://koreanexams.com
